---
title: "ggplot2 Graphics"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(prompt = "true", strip.white=TRUE, comment = NA, collapse=TRUE, cache = TRUE, fig.align="center", fig.width=5)
```

## ggplot2 Graphics

The package `ggplot2` by Hadley Wickham implements graphs based on the grammar of graphs ideas. The concept for this plotting framework was laid out by Leland Wilkinson in his 1999 book *Grammar of Graphics*.

It has two main principles: 

- Graphics consist of distinct layers of grammatical elements
- Meaningful plots are built through aesthetic mappings

There are seven grammatical elements in total, three are essential:

- data, the dataset being plotted
- aesthetics, the scales onto which we map our data
- geometries, refers to the actual shape of the data in the plot

The non-essential ones include:

- facets, 
- statistics
- coordinates
- themes

<center>![](/home/Fabian2/Desktop/StatComp/figures/grammar.png)</center>

A good reference for ggplot can be found at <http://ggplot2.tidyverse.org/reference/>.


## Principles of ggplot

All plots are generated with the same function: `ggplot()`. However, this function only initializes a ggplot object. It can be used to declare the input data frame for a graphic and to specify the set of plot aesthetics intended to be common throughout all subsequent layers unless specifically overridden.

```
ggplot(data = NULL, mapping = aes(), ..., environment = parent.frame())
```

It has two main arguments: 

`data` Default dataset to use for plot. If not already a data.frame, will be converted to one by fortify. If not specified, must be suppled in each layer added to the plot.

`mapping` Default list of aesthetic mappings to use for plot. If not specified, must be suppled in each layer added to the plot.

```{r }
library(ggplot2)
p <- ggplot(data = mpg, mapping = aes(x = displ, y = hwy))

```

There are three common ways to invoke `ggplot()`:

`ggplot(df, aes(x, y, <other aesthetics>))`

`ggplot(df)`

`ggplot()`

The first method is recommended if all layers use the same data and the same set of aesthetics, although this method can also be used to add a layer using data from another data frame. See the first example below. The second method specifies the default data frame to use for the plot, but no aesthetics are defined up front. This is useful when one data frame is used predominantly as layers are added, but the aesthetics may vary from one layer to another. The third method initializes a skeleton ggplot object which is fleshed out as layers are added. This method is useful when multiple data frames are used to produce different layers, as is often the case in complex graphics.

In order to see something, we have add "layers". These are added by using the `+` operator. Behind the scenes it calls the `layer()` function to create a new layer. You will never use the layer function, but it is good for your understanding of how ggplot2 works.

```
p + layer(
  mapping = NULL, 
  data = NULL,
  geom = "point", geom_params = list(),
  stat = "identity", stat_params = list(),
  position = "identity"
)
```

This call fully specifies the five components to the layer:

- `mapping`: A set of aesthetic mappings, specified using the `aes()` function and combined with the plot defaults as described in aesthetic mappings. If `NULL`, uses the default mapping set in ggplot().

- `data`: A dataset which overrides the default plot dataset. It is usually omitted (set to NULL), in which case the layer will use the default data specified in ggplot(). The requirements for data are explained in more detail in data.

- `geom`: The name of the geometric object to use to draw each observation. Geoms are discussed in more detail in geom, and the toolbox explores their use in more depth. Geoms can have additional arguments. All geoms take aesthetics as parameters. If you supply an aesthetic (e.g. colour) as a parameter, it will not be scaled, allowing you to control the appearance of the plot, as described in setting vs. mapping. You can pass params in ... (in which case stat and geom parameters are automatically teased apart), or in a list passed to geom_params.

- `stat`: The name of the statistical tranformation to use. A statistical transformation performs some useful statistical summary is key to histograms and smoothes. To keep the data as is, use the “identity” stat. Learn more in statistical transformations. You only need to set one of stat and geom: every geom has a default stat, and every stat a default geom. Most stats take additional parameters to specify the details of statistical transformation. You can supply params either in ... (in which case stat and geom parameters are automatically teased apart), or in a list called stat_params.

- `position`: The method used to adjusting overlapping objects, like jittering, stacking or dodging. More details in position.

It’s useful to understand the `layer()` function so you have a understanding of the layer object. But you’ll rarely use the full `layer()` call because it’s so verbose. Instead, you’ll use the shortcut geom_ functions: `geom_point(mapping, data, ...)` is exactly equivalent to `layer(mapping, data, geom = "point", ...)`.

```{r}
p + geom_point()
```

Five components of every layer

### Data

Every layer must have some data associated with it, and that data must be in a data frame. However, the data on each layer doesn’t need to be the same, and it’s often useful to combine multiple datasets in a single plot. Let us illustrate this idea:

```{r }
mod <- loess(hwy ~ displ, data = mpg)
grid <- data.frame(displ = seq(min(mpg$displ), max(mpg$displ), length = 50))
grid$hwy <- predict(mod, newdata = grid)
std_resid <- resid(mod) / mod$s
outlier <- subset(mpg, abs(std_resid) > 2)
ggplot(mpg, aes(displ, hwy)) + 
  geom_point() + 
  geom_line(data = grid, colour = "blue", size = 1.5) + 
  geom_text(data = outlier, aes(label = model))

```



### Aesthetic mappings

The aesthetic mappings, defined with aes(), describe how variables are mapped to visual properties or aesthetics. aes() takes a sequence of aesthetic-variable pairs like this: 

```{r eval = FALSE}
aes(x = displ, y = hwy, colour = class)
```
Here we map x-position to `displ`, y-position to `hwy`, and colour to `class`. The names for the first two arguments can be ommitted, in which case they correspond to the x and y variables. That makes this specification equivalent to the one above:

```{r eval = FALSE}
aes(displ, hwy, colour = class)
```

Aesthetic mappings can be supplied in the initial ggplot() call, in individual layers, or in some combination of both. All of these calls create the same plot specification:

```{r eval = FALSE}
ggplot(mpg, aes(displ, hwy, colour = class)) + 
  geom_point()
ggplot(mpg, aes(displ, hwy)) + 
  geom_point(aes(colour = class))
ggplot(mpg, aes(displ)) + 
  geom_point(aes(y = hwy, colour = class))
ggplot(mpg) + 
  geom_point(aes(displ, hwy, colour = class))
```

The aesthetics set in the `ggplot()` function are the default for all other layers. You can, however, add, override, or even remove mappings (e.g. `aes(y=NULL)`) in the layers. 

```{r }
par(mfrow=c(1,2))
ggplot(mpg, aes(displ, hwy, colour = class)) + 
  geom_point() + 
  geom_smooth(se = FALSE)

ggplot(mpg, aes(displ, hwy)) + 
  geom_point(aes(colour = class)) + 
  geom_smooth(se = FALSE)
```


### Geoms

### Stats

### Position Adjustments


### Statistics Layer

There are two categories of functions: 
  - those called from within a geom
  - those called independently





## Examples of ggplot2 plots


# Univarite continuous variables

```{r}
vec <- data.frame("x"=rnorm(100))
ggplot(vec, aes(x=x)) + 
  geom_histogram(aes(y=..density..)) + 
  geom_rug() +
  stat_function(fun = dnorm, colour = "red",
                are = list(mean = mean(vec$x), sd = sd(vec$x)))
```



```{r}
vec <- data.frame("x"=rnorm(100))
slope <- diff(quantile(vec$x, c(0.25, 0.75))) / diff(qnorm(c(0.25, 0.75)))
int <- quantile(vec$x, 0.25) - slope * qnorm(0.25)
ggplot(vec, aes(sample=x)) + 
  stat_qq() + 
  geom_abline(aes(slope = slope, intercept = int), col="red")
  
```



Aus dem Dokument

```{r}

library(dplyr)

class <- mpg %>%
  group_by(class) %>%
  summarise(n = n(), hwy = mean(hwy))

class$n.spell <- paste0("n = ", class$n)

ggplot(data = mpg, aes(y=hwy, x=class)) + 
  geom_jitter() + 
  geom_point(data = class, aes(x=class, y=hwy), col = "red", size = 4) + 
  geom_text(data = class, aes(label = n.spell, y = 10 ))

```



Excercise 1

```{r }

ggplot(mpg) + 
  geom_point(aes(displ, hwy))

ggplot(data = mpg, mapping = aes(cty, hwy)) + 
 geom_point() +
 geom_smooth()

ggplot(diamonds, aes(carat, price)) + 
  geom_point(aes(log(brainwt), log(bodywt)), data = msleep)

```

Excercise 2

```{r }

ggplot(mpg) +
  geom_point(aes(class, cty)) + 
  geom_boxplot(aes(trans, hwy))

```







### Univariate categorical data

``` {r fig.align="center", fig.width=5}
ggplot(data = diamonds) +
  geom_bar(mapping = aes(x = cut))
```


### Univariate continuous data



``` {r fig.align="center", fig.width=5}
ggplot(data = diamonds) + 
  geom_histogram(mapping = aes(x = carat), binwidth = 0.5)
```




### Comparison between baseR and gglot2

A good way to compare to the two philosophies is to create the same plots with both aproaches. Let us have a look at a few excellent examples taken from the blog "Tufte in R" by Lukasz Piwek to be found under ![](http://motioninsocial.com/tufte/#introduction).

#### Minimal line plot in base graphics

``` {r fig.align="center", fig.width=5}
x <- 1967:1977
y <- c(0.5,1.8,4.6,5.3,5.3,5.7,5.4,5,5.5,6,5)
plot(y ~ x, axes=F, xlab="", ylab="", pch=16, type="b")
axis(1, at=x, label=x, tick=F, family="serif")
axis(2, at=seq(1,6,1), label=sprintf("$%s", seq(300,400,20)), tick=F, las=2, family="serif")
abline(h=6,lty=2)
abline(h=5,lty=2)
text(max(x), min(y)*2.5,"Per capita\nbudget expanditures\nin constant dollars", adj=1, 
     family="serif")
text(max(x), max(y)/1.08, labels="5%", family="serif")
```


#### Minimal line plot in ggplot2

``` {r fig.align="center", fig.width=5}
library(ggplot2)
library(ggthemes)
x <- 1967:1977
y <- c(0.5,1.8,4.6,5.3,5.3,5.7,5.4,5,5.5,6,5)
d <- data.frame(x, y)
ggplot(d, aes(x,y)) + geom_line() + geom_point(size=3) + theme_tufte(base_size = 15) +
  theme(axis.title=element_blank()) + geom_hline(yintercept = c(5,6), lty=2) + 
  scale_y_continuous(breaks=seq(1, 6, 1), label=sprintf("$%s",seq(300,400,20))) + 
  scale_x_continuous(breaks=x,label=x) +
  annotate("text", x = c(1977,1977.2), y = c(1.5,5.5), adj=1,  family="serif",
           label = c("Per capita\nbudget expandures\nin constant dollars", "5%"))
```

#### Dot-dash plot in base graphics


``` {r fig.align="center", fig.width=5}
library(devtools)
source_url("https://raw.githubusercontent.com/sjmurdoch/fancyaxis/master/fancyaxis.R")
x <- faithful$waiting
y <- faithful$eruptions
plot(x, y, main="", axes=FALSE, pch=16, cex=0.8,
     xlab="Time till next eruption (min)", ylab="Duration (sec)", 
     xlim=c(min(x)/1.1, max(x)), ylim=c(min(y)/1.5, max(y)))
axis(1, tick=F)
axis(2, tick=F, las=2)
axisstripchart(faithful$waiting, 1)
axisstripchart(faithful$eruptions, 2)
```


#### Dot-dash plot in ggplot2


``` {r fig.align="center", fig.width=5}
library(ggplot2)
library(ggExtra)
library(ggthemes)
p <- ggplot(faithful, aes(waiting, eruptions)) + geom_point() + theme_tufte(ticks=F)
ggMarginal(p, type = "histogram", fill="transparent")
```

#### Marginal histogram scatterplot with base graphics

``` {r fig.align="center", fig.width=5}
library(devtools)
source_url("https://raw.githubusercontent.com/sjmurdoch/fancyaxis/master/fancyaxis.R")
x <- faithful$waiting
y <- faithful$eruptions
plot(x, y, main="", axes=FALSE, pch=16, cex=0.8,
     xlab="Time till next eruption (min)", ylab="Duration (sec)", 
     xlim=c(min(x)/1.1, max(x)), ylim=c(min(y)/1.5, max(y)))
axis(1, tick=F)
axis(2, tick=F, las=2)
axisstripchart(faithful$waiting, 1)
axisstripchart(faithful$eruptions, 2)
```

#### Marginal histogram scatterplot with ggplot2

``` {r fig.align="center", fig.width=5}
library(ggplot2)
library(ggExtra)
library(ggthemes)
p <- ggplot(faithful, aes(waiting, eruptions)) + geom_point() + theme_tufte(ticks=F)
ggMarginal(p, type = "histogram", fill="transparent")
```


#### Slopegraph in base graphics

``` {r fig.align="center", fig.width=5, fig.height=12}
library(devtools)
install_github("leeper/slopegraph")#install Leeper's package from Github
data(cancer)
slopegraph(cancer, col.lines = 'gray', col.lab = 1, col.num = 1,
           xlim = c(-.2,5),
           main = "Estimate of % survival rates",
           xlabels = c('5 Year','10 Year','15 Year','20 Year'))
```

#### Slopegraph in ggplot2

``` {r fig.align="center", fig.width=5}
library(ggplot2)
library(ggthemes)
library(devtools)
library(RCurl)
library(plyr)
source_url("https://raw.githubusercontent.com/jkeirstead/r-slopegraph/master/slopegraph.r")
d <- read.csv(text = getURL("https://raw.githubusercontent.com/jkeirstead/r-slopegraph/master/cancer_survival_rates.csv"))
df <- build_slopegraph(d, x="year", y="value", group="group", method="tufte", min.space=0.04)
df <- transform(df, x=factor(x, levels=c(5,10,15,20),
                              labels=c("5 years","10 years","15 years","20 years")), y=round(y))
 plot_slopegraph(df) + labs(title="Estimates of % survival rates") +
   theme_tufte(base_size=16, ticks=F) + theme(axis.title=element_blank())
```


